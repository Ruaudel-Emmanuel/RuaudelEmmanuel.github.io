<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G√©n√©rateur de Devis Pro + Dashboard</title>
    <!-- SheetJS pour Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
    <!-- Chart.js pour les graphiques -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- jsPDF et html2pdf pour PDF avanc√© -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --primary: #2180d1;
            --success: #20a85d;
            --warning: #ff7f00;
            --danger: #d32f2f;
            --light-bg: #f5f7fa;
            --border: #e0e4e8;
            --text-dark: #1a1a1a;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--light-bg);
            color: var(--text-dark);
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        h1 {
            color: var(--primary);
            font-size: 28px;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab-btn {
            background: white;
            border: 2px solid var(--border);
            padding: 12px 24px;
            cursor: pointer;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .tab-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        /* G√©n√©rateur Devis */
        .devis-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .form-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 13px;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(33, 128, 209, 0.1);
        }
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
        }
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        .btn-primary:hover {
            background: #1a6fbd;
            transform: translateY(-2px);
        }
        .btn-secondary {
            background: var(--light-bg);
            border: 2px solid var(--border);
            color: var(--text-dark);
        }
        .btn-secondary:hover {
            background: var(--border);
        }
        .btn-success {
            background: var(--success);
            color: white;
        }
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        .btn-small {
            padding: 8px 12px;
            font-size: 12px;
        }
        
        /* Devis en cours */
        .devis-preview {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .devis-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid var(--border);
            align-items: center;
        }
        .devis-item-info {
            flex: 1;
        }
        .devis-item-amount {
            font-weight: 700;
            min-width: 100px;
            text-align: right;
        }
        .devis-totals {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid var(--primary);
        }
        .total-row {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 14px;
        }
        .total-row.final {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            margin-top: 15px;
            padding-top: 10px;
            border-top: 2px solid var(--primary);
        }
        
        /* Dashboard */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .kpi-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary);
        }
        .kpi-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            margin: 10px 0;
        }
        .kpi-label {
            font-size: 13px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .chart-title {
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--text-dark);
        }
        
        /* Filtres */
        .filters {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        /* Historique */
        .history-table {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        thead {
            background: var(--light-bg);
            border-bottom: 2px solid var(--border);
        }
        th {
            padding: 12px;
            text-align: left;
            font-weight: 700;
            font-size: 13px;
            text-transform: uppercase;
        }
        td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }
        tr:hover {
            background: var(--light-bg);
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-accept {
            background: rgba(32, 168, 93, 0.1);
            color: var(--success);
        }
        .status-reject {
            background: rgba(211, 47, 47, 0.1);
            color: var(--danger);
        }
        .status-pending {
            background: rgba(255, 127, 0, 0.1);
            color: var(--warning);
        }
        
        /* Actions */
        .actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #666;
        }
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid var(--primary);
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 13px;
            color: #1565c0;
        }
        @media (max-width: 768px) {
            .devis-container {
                grid-template-columns: 1fr;
            }
            .charts-grid {
                grid-template-columns: 1fr;
            }
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            table {
                font-size: 12px;
            }
            th, td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìã G√©n√©rateur Devis Pro</h1>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-secondary btn-small" onclick="app.clearAllData()">üóëÔ∏è R√©initialiser</button>
                <button class="btn btn-secondary btn-small" onclick="app.importDemoData()">üìä Donn√©es d√©mo</button>
            </div>
        </header>

        <!-- Onglets -->
        <div class="tabs">
            <button class="tab-btn active" onclick="app.switchTab('devis')">üìù Cr√©er Devis</button>
            <button class="tab-btn" onclick="app.switchTab('dashboard')">üìä Dashboard</button>
            <button class="tab-btn" onclick="app.switchTab('history')">üìã Historique</button>
            <button class="tab-btn" onclick="app.switchTab('providers')">üè™ Prestataires</button>
        </div>

        <!-- TAB 1: Cr√©er Devis -->
        <div id="devis" class="tab-content active">
            <div class="devis-container">
                <!-- Formulaire -->
                <div class="form-section">
                    <h2 style="margin-bottom: 20px; color: var(--primary);">Informations Devis</h2>
                    
                    <div class="form-group">
                        <label>Nom du client</label>
                        <input type="text" id="clientName" placeholder="Ex: Entreprise ABC">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="clientEmail" placeholder="contact@example.com">
                    </div>
                    <div class="form-group">
                        <label>T√©l√©phone</label>
                        <input type="tel" id="clientPhone" placeholder="06 12 34 56 78">
                    </div>
                    <div class="form-group">
                        <label>Titre du projet</label>
                        <input type="text" id="projectTitle" placeholder="Ex: Am√©nagement jardin">
                    </div>
                    <div class="form-group">
                        <label>Date du devis</label>
                        <input type="date" id="devisDate">
                    </div>
                    <div class="form-group">
                        <label>Validit√© (jours)</label>
                        <input type="number" id="validity" value="30" min="1">
                    </div>

                    <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--border);">
                    
                    <h3 style="margin-bottom: 15px; color: var(--primary); font-size: 16px;">Ajouter Prestations</h3>
                    
                    <div class="form-group">
                        <label>Prestataire</label>
                        <select id="providerSelect" onchange="app.updateTypes()">
                            <option value="">-- Choisir un prestataire --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Type de prestation</label>
                        <select id="serviceType">
                            <option value="">-- D'abord, choisir un prestataire --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Quantit√©/Surface</label>
                        <input type="number" id="quantity" placeholder="10" min="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Unit√©</label>
                        <select id="unit">
                            <option value="m¬≤">m¬≤</option>
                            <option value="m">m</option>
                            <option value="h">h (heures)</option>
                            <option value="jour">jour</option>
                            <option value="U">U (unit√©)</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-success" onclick="app.addService()">‚úÖ Ajouter √† la devis</button>
                </div>

                <!-- Aper√ßu Devis -->
                <div class="devis-preview">
                    <h2 style="margin-bottom: 20px; color: var(--primary);">üìÑ Aper√ßu Devis</h2>
                    
                    <div id="devisPreview" style="font-size: 13px; line-height: 1.6;">
                        <p><strong>Client:</strong> <span id="prevClient">-</span></p>
                        <p><strong>Titre:</strong> <span id="prevTitle">-</span></p>
                        <p><strong>Date:</strong> <span id="prevDate">-</span></p>
                        <p><strong>Validit√©:</strong> <span id="prevValidity">-</span></p>
                    </div>

                    <div id="servicesList" style="margin: 20px 0;"></div>

                    <div class="devis-totals">
                        <div class="total-row">
                            <span>Sous-total HT:</span>
                            <span id="totalHT">0.00 ‚Ç¨</span>
                        </div>
                        <div class="total-row">
                            <span>TVA (20%):</span>
                            <span id="totalTVA">0.00 ‚Ç¨</span>
                        </div>
                        <div class="total-row final">
                            <span>TOTAL TTC:</span>
                            <span id="totalTTC">0.00 ‚Ç¨</span>
                        </div>
                    </div>

                    <div class="actions" style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="app.generatePDF()">‚úÖ G√©n√©rer PDF</button>
                        <button class="btn btn-success" onclick="app.exportExcel()">üì• Export Excel</button>
                        <button class="btn btn-secondary" onclick="app.resetForm()">üîÑ R√©initialiser</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 2: Dashboard -->
        <div id="dashboard" class="tab-content">
            <div class="filters">
                <div class="filter-grid">
                    <div class="form-group" style="margin: 0;">
                        <label style="margin-bottom: 8px;">Ann√©e</label>
                        <select id="filterYear" onchange="app.updateDashboard()">
                            <option value="">Toutes</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label style="margin-bottom: 8px;">Type de prestation</label>
                        <select id="filterType" onchange="app.updateDashboard()">
                            <option value="">Tous</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label style="margin-bottom: 8px;">Prestataire</label>
                        <select id="filterProvider" onchange="app.updateDashboard()">
                            <option value="">Tous</option>
                        </select>
                    </div>
                    <button class="btn btn-secondary" onclick="app.resetFilters()" style="align-self: flex-end; margin-bottom: 0;">R√©initialiser</button>
                </div>
            </div>

            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-label">Nombre de devis</div>
                    <div class="kpi-value" id="kpiCount">0</div>
                </div>
                <div class="kpi-card" style="border-left-color: var(--success);">
                    <div class="kpi-label">Taux d'acceptation</div>
                    <div class="kpi-value" id="kpiRate">0%</div>
                </div>
                <div class="kpi-card" style="border-left-color: var(--warning);">
                    <div class="kpi-label">CA Total</div>
                    <div class="kpi-value" id="kpiCA">0 ‚Ç¨</div>
                </div>
                <div class="kpi-card" style="border-left-color: #9c27b0;">
                    <div class="kpi-label">Panier moyen</div>
                    <div class="kpi-value" id="kpiAvg">0 ‚Ç¨</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-title">CA par mois</div>
                    <canvas id="chartCA"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Devis par type</div>
                    <canvas id="chartType"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Top 5 clients</div>
                    <canvas id="chartClients"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Statuts devis</div>
                    <canvas id="chartStatus"></canvas>
                </div>
            </div>
        </div>

        <!-- TAB 3: Historique -->
        <div id="history" class="tab-content">
            <div class="actions">
                <button class="btn btn-primary" onclick="app.exportAllToExcel()">üì• Exporter tout en Excel</button>
                <button class="btn btn-secondary" onclick="app.printHistory()">üñ®Ô∏è Imprimer</button>
            </div>

            <div class="history-table">
                <table id="historyTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Client</th>
                            <th>Projet</th>
                            <th>Type</th>
                            <th>Montant TTC</th>
                            <th>Statut</th>
                            <th>Prestataire</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- TAB 4: Prestataires -->
        <div id="providers" class="tab-content">
            <div class="devis-container">
                <div class="form-section">
                    <h2 style="margin-bottom: 20px; color: var(--primary);">Ajouter Prestataire</h2>
                    
                    <div class="form-group">
                        <label>Nom du prestataire</label>
                        <input type="text" id="providerName" placeholder="Ex: Jardins Verts SARL">
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="providerType">
                            <option value="Fournisseur mat√©riau">üèóÔ∏è Fournisseur mat√©riau</option>
                            <option value="Sous-traitant">üîß Sous-traitant</option>
                            <option value="√âquipement/Location">üöö √âquipement/Location</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Contact</label>
                        <input type="text" id="providerContact" placeholder="contact@example.com ou 06 12 34 56 78">
                    </div>

                    <h3 style="margin-bottom: 15px; margin-top: 30px; color: var(--primary); font-size: 16px;">Services & Tarifs</h3>
                    
                    <div class="form-group">
                        <label>Type de service</label>
                        <input type="text" id="serviceName" placeholder="Ex: Tondage pelouse">
                    </div>
                    <div class="form-group">
                        <label>Prix unitaire (‚Ç¨)</label>
                        <input type="number" id="servicePrice" placeholder="50" min="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Unit√©</label>
                        <select id="serviceUnit">
                            <option value="m¬≤">m¬≤</option>
                            <option value="m">m</option>
                            <option value="h">h (heures)</option>
                            <option value="jour">jour</option>
                            <option value="U">U (unit√©)</option>
                        </select>
                    </div>

                    <button class="btn btn-success" onclick="app.addProvider()">‚úÖ Ajouter Prestataire</button>
                </div>

                <div class="form-section">
                    <h2 style="margin-bottom: 20px; color: var(--primary);">Prestataires Enregistr√©s</h2>
                    <div id="providersList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour voir/√©diter un devis -->
    <div id="devisModal" class="modal" onclick="if(event.target === this) app.closeModal()">
        <div class="modal-content">
            <div class="modal-header">
                <h2>D√©tails Devis</h2>
                <button class="close-btn" onclick="app.closeModal()">&times;</button>
            </div>
            <div id="modalBody"></div>
            <div class="actions">
                <button class="btn btn-primary" onclick="app.updateDevisStatus('accepted')">‚úÖ Accept√©</button>
                <button class="btn btn-danger" onclick="app.updateDevisStatus('rejected')">‚ùå Refus√©</button>
                <button class="btn btn-secondary" onclick="app.closeModal()">Fermer</button>
            </div>
        </div>
    </div>

    <script>
        const app = {
            providers: [],
            devis: [],
            currentEditingId: null,

            init() {
                this.loadData();
                this.setCurrentDate();
                this.renderProviders();
                this.updateYearFilter();
                document.getElementById('devisDate').valueAsDate = new Date();
                if (this.devis.length === 0) {
                    this.showInfo("üí° Pas de devis encore. Commencez par ajouter un prestataire !");
                }
            },

            // === STORAGE ===
            saveData() {
                localStorage.setItem('devisApp', JSON.stringify({
                    providers: this.providers,
                    devis: this.devis
                }));
            },

            loadData() {
                const data = JSON.parse(localStorage.getItem('devisApp') || '{"providers":[],"devis":[]}');
                this.providers = data.providers;
                this.devis = data.devis;
            },

            clearAllData() {
                if (confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir supprimer TOUTES les donn√©es ?')) {
                    this.providers = [];
                    this.devis = [];
                    this.saveData();
                    location.reload();
                }
            },

            importDemoData() {
                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth() + 1;

                this.providers = [
                    {
                        id: 'p1',
                        name: 'Jardins Verts SARL',
                        type: 'Sous-traitant',
                        contact: 'contact@jardinsvert.fr',
                        services: [
                            { id: 's1', name: 'Tondage pelouse', price: 15, unit: 'm¬≤' },
                            { id: 's2', name: 'Taille haies', price: 45, unit: 'h' },
                            { id: 's3', name: 'Arrachage mauvaises herbes', price: 50, unit: 'jour' }
                        ]
                    },
                    {
                        id: 'p2',
                        name: 'Mat√©riaux Pro',
                        type: 'Fournisseur mat√©riau',
                        contact: 'ventes@materiaux.fr',
                        services: [
                            { id: 's4', name: 'Terrassement', price: 200, unit: 'm¬≥' },
                            { id: 's5', name: 'Gravier 0/4', price: 25, unit: 'tonne' }
                        ]
                    }
                ];

                this.devis = [
                    {
                        id: 'd1',
                        date: `${year}-${String(month-1).padStart(2,'0')}-15`,
                        client: 'Ch√¢teau de Rennes',
                        email: 'admin@chateau-rennes.fr',
                        phone: '02 99 12 34 56',
                        title: 'Am√©nagement jardin principal',
                        validity: 30,
                        services: [
                            { type: 'Tondage pelouse', quantity: 5000, unit: 'm¬≤', price: 15, provider: 'Jardins Verts SARL' }
                        ],
                        status: 'accepted'
                    },
                    {
                        id: 'd2',
                        date: `${year}-${String(month).padStart(2,'0')}-10`,
                        client: 'Universit√© Rennes 1',
                        email: 'maintenance@univ-rennes1.fr',
                        phone: '02 23 23 45 67',
                        title: 'Entretien espaces verts campus',
                        validity: 30,
                        services: [
                            { type: 'Taille haies', quantity: 20, unit: 'h', price: 45, provider: 'Jardins Verts SARL' }
                        ],
                        status: 'pending'
                    },
                    {
                        id: 'd3',
                        date: `${year}-${String(month).padStart(2,'0')}-05`,
                        client: 'Entreprise ABC Consulting',
                        email: 'contact@abc.com',
                        phone: '02 90 87 65 43',
                        title: 'R√©novation terrasse ext√©rieure',
                        validity: 30,
                        services: [
                            { type: 'Terrassement', quantity: 15, unit: 'm¬≥', price: 200, provider: 'Mat√©riaux Pro' }
                        ],
                        status: 'rejected'
                    }
                ];

                this.saveData();
                this.renderProviders();
                this.updateDashboard();
                this.renderHistory();
                this.showInfo('‚úÖ Donn√©es de d√©monstration import√©es !');
            },

            showInfo(msg) {
                alert(msg);
            },

            // === TABS ===
            switchTab(tabName) {
                document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
                document.getElementById(tabName).classList.add('active');
                event.target.classList.add('active');

                if (tabName === 'dashboard') {
                    this.updateDashboard();
                } else if (tabName === 'history') {
                    this.renderHistory();
                }
            },

            // === PROVIDERS ===
            addProvider() {
                const name = document.getElementById('providerName').value.trim();
                const type = document.getElementById('providerType').value;
                const contact = document.getElementById('providerContact').value.trim();
                const serviceName = document.getElementById('serviceName').value.trim();
                const servicePrice = parseFloat(document.getElementById('servicePrice').value) || 0;
                const serviceUnit = document.getElementById('serviceUnit').value;

                if (!name || !serviceName || servicePrice <= 0) {
                    alert('‚ùå Veuillez remplir tous les champs (nom, service, prix)');
                    return;
                }

                const provider = this.providers.find(p => p.name === name);
                if (provider) {
                    provider.services.push({
                        id: 's' + Date.now(),
                        name: serviceName,
                        price: servicePrice,
                        unit: serviceUnit
                    });
                } else {
                    this.providers.push({
                        id: 'p' + Date.now(),
                        name,
                        type,
                        contact,
                        services: [{
                            id: 's' + Date.now(),
                            name: serviceName,
                            price: servicePrice,
                            unit: serviceUnit
                        }]
                    });
                }

                this.saveData();
                this.renderProviders();
                this.resetProviderForm();
                alert('‚úÖ Prestataire ajout√© !');
            },

            resetProviderForm() {
                document.getElementById('providerName').value = '';
                document.getElementById('serviceName').value = '';
                document.getElementById('servicePrice').value = '';
            },

            renderProviders() {
                const select = document.getElementById('providerSelect');
                const list = document.getElementById('providersList');
                
                select.innerHTML = '<option value="">-- Choisir un prestataire --</option>';
                list.innerHTML = '';

                this.providers.forEach(p => {
                    select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                    
                    let servicesHtml = p.services.map(s => `
                        <div style="background: var(--light-bg); padding: 10px; border-radius: 4px; margin-bottom: 5px;">
                            ${s.name} - ${s.price}‚Ç¨/${s.unit}
                        </div>
                    `).join('');

                    list.innerHTML += `
                        <div style="background: white; border: 1px solid var(--border); border-radius: 6px; padding: 15px; margin-bottom: 15px;">
                            <h4 style="color: var(--primary); margin-bottom: 10px;">${p.name}</h4>
                            <p style="font-size: 12px; color: #666; margin-bottom: 10px;"><strong>Type:</strong> ${p.type}</p>
                            <p style="font-size: 12px; color: #666; margin-bottom: 10px;"><strong>Contact:</strong> ${p.contact}</p>
                            <div>${servicesHtml}</div>
                            <button class="btn btn-danger btn-small" onclick="app.deleteProvider('${p.id}')">üóëÔ∏è Supprimer</button>
                        </div>
                    `;
                });
            },

            deleteProvider(id) {
                if (confirm('√ätes-vous s√ªr ?')) {
                    this.providers = this.providers.filter(p => p.id !== id);
                    this.saveData();
                    this.renderProviders();
                }
            },

            updateTypes() {
                const select = document.getElementById('providerSelect');
                const typeSelect = document.getElementById('serviceType');
                const providerId = select.value;

                typeSelect.innerHTML = '<option value="">-- Choisir un service --</option>';
                if (providerId) {
                    const provider = this.providers.find(p => p.id === providerId);
                    if (provider) {
                        provider.services.forEach(s => {
                            typeSelect.innerHTML += `<option value="${s.id}" data-price="${s.price}">${s.name}</option>`;
                        });
                    }
                }
            },

            // === DEVIS ===
            setCurrentDate() {
                document.getElementById('devisDate').valueAsDate = new Date();
            },

            addService() {
                const providerId = document.getElementById('providerSelect').value;
                const serviceId = document.getElementById('serviceType').value;
                const quantity = parseFloat(document.getElementById('quantity').value) || 0;
                const unit = document.getElementById('unit').value;

                if (!providerId || !serviceId || quantity <= 0) {
                    alert('‚ùå Veuillez remplir tous les champs');
                    return;
                }

                const provider = this.providers.find(p => p.id === providerId);
                const service = provider.services.find(s => s.id === serviceId);

                if (!this.currentDevis) {
                    this.currentDevis = {
                        services: []
                    };
                }

                this.currentDevis.services.push({
                    type: service.name,
                    quantity,
                    unit,
                    price: service.price,
                    provider: provider.name
                });

                this.updateDevisPreview();
                document.getElementById('quantity').value = '';
            },

            updateDevisPreview() {
                if (!this.currentDevis) return;

                document.getElementById('prevClient').textContent = document.getElementById('clientName').value || '-';
                document.getElementById('prevTitle').textContent = document.getElementById('projectTitle').value || '-';
                document.getElementById('prevDate').textContent = document.getElementById('devisDate').value || '-';
                document.getElementById('prevValidity').textContent = document.getElementById('validity').value + ' jours';

                let servicesHtml = '';
                let totalHT = 0;

                this.currentDevis.services.forEach((s, idx) => {
                    const amount = s.quantity * s.price;
                    totalHT += amount;
                    servicesHtml += `
                        <div class="devis-item">
                            <div class="devis-item-info">
                                <div style="font-weight: 600;">${s.type}</div>
                                <div style="font-size: 12px; color: #666;">${s.quantity} ${s.unit} √ó ${s.price}‚Ç¨</div>
                                <div style="font-size: 11px; color: #999;">${s.provider}</div>
                            </div>
                            <div class="devis-item-amount">${amount.toFixed(2)}‚Ç¨</div>
                            <button class="btn btn-danger btn-small" onclick="app.removeService(${idx})" style="margin-left: 10px;">‚úï</button>
                        </div>
                    `;
                });

                document.getElementById('servicesList').innerHTML = servicesHtml;

                const tva = totalHT * 0.20;
                const totalTTC = totalHT + tva;

                document.getElementById('totalHT').textContent = totalHT.toFixed(2) + ' ‚Ç¨';
                document.getElementById('totalTVA').textContent = tva.toFixed(2) + ' ‚Ç¨';
                document.getElementById('totalTTC').textContent = totalTTC.toFixed(2) + ' ‚Ç¨';
            },

            removeService(idx) {
                if (this.currentDevis) {
                    this.currentDevis.services.splice(idx, 1);
                    this.updateDevisPreview();
                }
            },

            generatePDF() {
                if (!this.currentDevis || this.currentDevis.services.length === 0) {
                    alert('‚ùå Ajoutez au moins une prestation');
                    return;
                }

                const doc = new jsPDF();
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                let yPos = 20;

                // En-t√™te
                doc.setFontSize(20);
                doc.text('DEVIS', 20, yPos);
                yPos += 15;

                // Info client
                doc.setFontSize(10);
                doc.text(`Client: ${document.getElementById('clientName').value}`, 20, yPos);
                yPos += 6;
                doc.text(`Email: ${document.getElementById('clientEmail').value}`, 20, yPos);
                yPos += 6;
                doc.text(`T√©l√©phone: ${document.getElementById('clientPhone').value}`, 20, yPos);
                yPos += 10;

                // Titre projet
                doc.setFontSize(12);
                doc.text(`Projet: ${document.getElementById('projectTitle').value}`, 20, yPos);
                yPos += 8;

                doc.setFontSize(9);
                doc.text(`Date: ${document.getElementById('devisDate').value}`, 20, yPos);
                doc.text(`Validit√©: ${document.getElementById('validity').value} jours`, 120, yPos);
                yPos += 12;

                // Tableau prestations
                let totalHT = 0;
                doc.text('Prestation', 20, yPos);
                doc.text('Qt√©', 100, yPos);
                doc.text('Prix U.', 130, yPos);
                doc.text('Total', 160, yPos);
                yPos += 8;
                doc.setDrawColor(200);
                doc.line(20, yPos - 2, 190, yPos - 2);

                this.currentDevis.services.forEach(s => {
                    const amount = s.quantity * s.price;
                    totalHT += amount;
                    doc.text(s.type.substring(0, 30), 20, yPos);
                    doc.text(s.quantity + ' ' + s.unit, 100, yPos);
                    doc.text(s.price.toFixed(2), 130, yPos);
                    doc.text(amount.toFixed(2), 160, yPos);
                    yPos += 7;
                });

                yPos += 5;
                doc.line(20, yPos - 2, 190, yPos - 2);
                doc.setFont(undefined, 'bold');
                doc.text('TOTAL HT:', 130, yPos);
                doc.text(totalHT.toFixed(2) + ' ‚Ç¨', 160, yPos);
                yPos += 8;

                const tva = totalHT * 0.20;
                doc.setFont(undefined, 'normal');
                doc.text('TVA (20%):', 130, yPos);
                doc.text(tva.toFixed(2) + ' ‚Ç¨', 160, yPos);
                yPos += 8;

                const totalTTC = totalHT + tva;
                doc.setFont(undefined, 'bold');
                doc.setFontSize(12);
                doc.text('TOTAL TTC:', 130, yPos);
                doc.text(totalTTC.toFixed(2) + ' ‚Ç¨', 160, yPos);

                const filename = `Devis_${document.getElementById('clientName').value}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(filename);

                this.saveDevis();
            },

            exportExcel() {
                if (!this.currentDevis || this.currentDevis.services.length === 0) {
                    alert('‚ùå Ajoutez au moins une prestation');
                    return;
                }

                const totalHT = this.currentDevis.services.reduce((sum, s) => sum + (s.quantity * s.price), 0);
                const tva = totalHT * 0.20;
                const totalTTC = totalHT + tva;

                const data = [[
                    'Date Devis',
                    'Client',
                    'Titre Projet',
                    'Prestation',
                    'Quantit√©',
                    'Unit√©',
                    'Prix Unitaire',
                    'Montant',
                    'Montant HT',
                    'TVA (20%)',
                    'Montant TTC',
                    'Prestataire'
                ]];

                this.currentDevis.services.forEach(s => {
                    const amount = s.quantity * s.price;
                    data.push([
                        document.getElementById('devisDate').value,
                        document.getElementById('clientName').value,
                        document.getElementById('projectTitle').value,
                        s.type,
                        s.quantity,
                        s.unit,
                        s.price,
                        amount,
                        totalHT,
                        tva,
                        totalTTC,
                        s.provider
                    ]);
                });

                const ws = XLSX.utils.aoa_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Devis');
                
                // Formatage largeurs colonnes
                ws['!cols'] = [
                    {wch: 12}, {wch: 15}, {wch: 20}, {wch: 20},
                    {wch: 10}, {wch: 8}, {wch: 12}, {wch: 12},
                    {wch: 12}, {wch: 10}, {wch: 12}, {wch: 15}
                ];

                const filename = `Devis_${document.getElementById('clientName').value}_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, filename);

                this.saveDevis();
            },

            exportAllToExcel() {
                if (this.devis.length === 0) {
                    alert('‚ùå Aucun devis √† exporter');
                    return;
                }

                const data = [[
                    'Date',
                    'Client',
                    'Projet',
                    'Prestation',
                    'Surface/Qt√©',
                    'Unit√©',
                    'Montant HT',
                    'TVA',
                    'Montant TTC',
                    'Statut',
                    'Prestataire'
                ]];

                this.devis.forEach(d => {
                    d.services.forEach(s => {
                        const amount = s.quantity * s.price;
                        const ht = amount;
                        const tva = ht * 0.20;
                        const ttc = ht + tva;
                        data.push([
                            d.date,
                            d.client,
                            d.title,
                            s.type,
                            s.quantity,
                            s.unit,
                            ht.toFixed(2),
                            tva.toFixed(2),
                            ttc.toFixed(2),
                            d.status === 'accepted' ? '‚úÖ Accept√©' : d.status === 'rejected' ? '‚ùå Refus√©' : '‚è≥ En cours',
                            s.provider
                        ]);
                    });
                });

                const ws = XLSX.utils.aoa_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Historique');
                
                ws['!cols'] = [
                    {wch: 12}, {wch: 15}, {wch: 20}, {wch: 20},
                    {wch: 10}, {wch: 8}, {wch: 12}, {wch: 10},
                    {wch: 12}, {wch: 12}, {wch: 15}
                ];

                XLSX.writeFile(wb, `Historique_Devis_${new Date().toISOString().split('T')[0]}.xlsx`);
            },

            saveDevis() {
                const clientName = document.getElementById('clientName').value;
                if (!clientName) {
                    alert('‚ùå Remplissez le nom du client');
                    return;
                }

                const devis = {
                    id: 'd' + Date.now(),
                    date: document.getElementById('devisDate').value,
                    client: clientName,
                    email: document.getElementById('clientEmail').value,
                    phone: document.getElementById('clientPhone').value,
                    title: document.getElementById('projectTitle').value,
                    validity: document.getElementById('validity').value,
                    services: this.currentDevis.services,
                    status: 'pending'
                };

                this.devis.push(devis);
                this.saveData();
                this.resetForm();
                alert('‚úÖ Devis sauvegard√© dans l\'historique !');
            },

            resetForm() {
                document.getElementById('clientName').value = '';
                document.getElementById('clientEmail').value = '';
                document.getElementById('clientPhone').value = '';
                document.getElementById('projectTitle').value = '';
                document.getElementById('quantity').value = '';
                document.getElementById('providerSelect').value = '';
                document.getElementById('serviceType').innerHTML = '<option>Choisir un service</option>';
                this.currentDevis = null;
                this.updateDevisPreview();
                this.setCurrentDate();
            },

            // === HISTORY ===
            renderHistory() {
                const tbody = document.getElementById('historyBody');
                tbody.innerHTML = '';

                if (this.devis.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #999;">Aucun devis enregistr√©</td></tr>';
                    return;
                }

                this.devis.forEach(d => {
                    const totalAmount = d.services.reduce((sum, s) => sum + (s.quantity * s.price * 1.20), 0);
                    const statusClass = d.status === 'accepted' ? 'status-accept' : d.status === 'rejected' ? 'status-reject' : 'status-pending';
                    const statusText = d.status === 'accepted' ? '‚úÖ Accept√©' : d.status === 'rejected' ? '‚ùå Refus√©' : '‚è≥ En cours';

                    tbody.innerHTML += `
                        <tr>
                            <td>${d.date}</td>
                            <td>${d.client}</td>
                            <td>${d.title}</td>
                            <td>${d.services.map(s => s.type).join(', ').substring(0, 20)}...</td>
                            <td>${totalAmount.toFixed(2)} ‚Ç¨</td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                            <td>${d.services[0]?.provider || '-'}</td>
                            <td>
                                <button class="btn btn-secondary btn-small" onclick="app.viewDevis('${d.id}')">üëÅÔ∏è</button>
                                <button class="btn btn-danger btn-small" onclick="app.deleteDevis('${d.id}')">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `;
                });
            },

            viewDevis(id) {
                const devis = this.devis.find(d => d.id === id);
                if (!devis) return;

                this.currentEditingId = id;
                let html = `
                    <h3>${devis.client} - ${devis.title}</h3>
                    <p><strong>Date:</strong> ${devis.date}</p>
                    <p><strong>Email:</strong> ${devis.email}</p>
                    <p><strong>T√©l√©phone:</strong> ${devis.phone}</p>
                    <hr>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                        <tr style="background: var(--light-bg);">
                            <th style="padding: 10px; text-align: left;">Prestation</th>
                            <th style="padding: 10px; text-align: right;">Qt√©</th>
                            <th style="padding: 10px; text-align: right;">P.U.</th>
                            <th style="padding: 10px; text-align: right;">Total</th>
                        </tr>
                `;

                let totalHT = 0;
                devis.services.forEach(s => {
                    const amount = s.quantity * s.price;
                    totalHT += amount;
                    html += `
                        <tr>
                            <td style="padding: 10px; border-bottom: 1px solid var(--border);">${s.type}</td>
                            <td style="padding: 10px; text-align: right; border-bottom: 1px solid var(--border);">${s.quantity} ${s.unit}</td>
                            <td style="padding: 10px; text-align: right; border-bottom: 1px solid var(--border);">${s.price.toFixed(2)}‚Ç¨</td>
                            <td style="padding: 10px; text-align: right; border-bottom: 1px solid var(--border);">${amount.toFixed(2)}‚Ç¨</td>
                        </tr>
                    `;
                });

                const tva = totalHT * 0.20;
                const totalTTC = totalHT + tva;

                html += `
                    <tr style="background: var(--light-bg); font-weight: bold;">
                        <td colspan="3" style="padding: 10px; text-align: right;">TOTAL HT:</td>
                        <td style="padding: 10px; text-align: right;">${totalHT.toFixed(2)}‚Ç¨</td>
                    </tr>
                    <tr>
                        <td colspan="3" style="padding: 10px; text-align: right;">TVA (20%):</td>
                        <td style="padding: 10px; text-align: right;">${tva.toFixed(2)}‚Ç¨</td>
                    </tr>
                    <tr style="background: var(--primary); color: white; font-weight: bold;">
                        <td colspan="3" style="padding: 10px; text-align: right;">TOTAL TTC:</td>
                        <td style="padding: 10px; text-align: right;">${totalTTC.toFixed(2)}‚Ç¨</td>
                    </tr>
                    </table>
                    <p><strong>Statut actuel:</strong> <span class="status-badge ${devis.status === 'accepted' ? 'status-accept' : devis.status === 'rejected' ? 'status-reject' : 'status-pending'}">${devis.status === 'accepted' ? '‚úÖ Accept√©' : devis.status === 'rejected' ? '‚ùå Refus√©' : '‚è≥ En cours'}</span></p>
                `;

                document.getElementById('modalBody').innerHTML = html;
                document.getElementById('devisModal').classList.add('active');
            },

            deleteDevis(id) {
                if (confirm('Supprimer ce devis ?')) {
                    this.devis = this.devis.filter(d => d.id !== id);
                    this.saveData();
                    this.renderHistory();
                    this.updateDashboard();
                }
            },

            updateDevisStatus(status) {
                if (!this.currentEditingId) return;
                const devis = this.devis.find(d => d.id === this.currentEditingId);
                if (devis) {
                    devis.status = status;
                    this.saveData();
                    this.closeModal();
                    this.renderHistory();
                    this.updateDashboard();
                    alert('‚úÖ Statut mis √† jour');
                }
            },

            closeModal() {
                document.getElementById('devisModal').classList.remove('active');
            },

            printHistory() {
                window.print();
            },

            // === DASHBOARD ===
            updateDashboard() {
                const yearFilter = document.getElementById('filterYear').value;
                const typeFilter = document.getElementById('filterType').value;
                const providerFilter = document.getElementById('filterProvider').value;

                let filtered = this.devis;

                if (yearFilter) {
                    filtered = filtered.filter(d => d.date.startsWith(yearFilter));
                }
                if (typeFilter) {
                    filtered = filtered.filter(d => d.services.some(s => s.type === typeFilter));
                }
                if (providerFilter) {
                    filtered = filtered.filter(d => d.services.some(s => s.provider === providerFilter));
                }

                // KPI
                const count = filtered.length;
                const accepted = filtered.filter(d => d.status === 'accepted').length;
                const rate = count > 0 ? ((accepted / count) * 100).toFixed(1) : 0;
                const ca = filtered.reduce((sum, d) => sum + d.services.reduce((s, srv) => s + (srv.quantity * srv.price * 1.20), 0), 0);
                const avg = count > 0 ? (ca / count).toFixed(2) : 0;

                document.getElementById('kpiCount').textContent = count;
                document.getElementById('kpiRate').textContent = rate + '%';
                document.getElementById('kpiCA').textContent = ca.toFixed(2) + ' ‚Ç¨';
                document.getElementById('kpiAvg').textContent = avg + ' ‚Ç¨';

                this.renderCharts(filtered);
                this.updateFilterOptions();
            },

            updateYearFilter() {
                const years = new Set();
                this.devis.forEach(d => {
                    const year = d.date.substring(0, 4);
                    if (year) years.add(year);
                });

                const yearSelect = document.getElementById('filterYear');
                const currentValue = yearSelect.value;
                yearSelect.innerHTML = '<option value="">Toutes les ann√©es</option>';
                Array.from(years).sort().reverse().forEach(y => {
                    yearSelect.innerHTML += `<option value="${y}">${y}</option>`;
                });
                yearSelect.value = currentValue;
            },

            updateFilterOptions() {
                const types = new Set();
                const providers = new Set();

                this.devis.forEach(d => {
                    d.services.forEach(s => {
                        types.add(s.type);
                        providers.add(s.provider);
                    });
                });

                const typeSelect = document.getElementById('filterType');
                const providerSelect = document.getElementById('filterProvider');
                const typeValue = typeSelect.value;
                const providerValue = providerSelect.value;

                typeSelect.innerHTML = '<option value="">Tous les types</option>';
                providerSelect.innerHTML = '<option value="">Tous les prestataires</option>';

                Array.from(types).sort().forEach(t => {
                    typeSelect.innerHTML += `<option value="${t}">${t}</option>`;
                });

                Array.from(providers).sort().forEach(p => {
                    providerSelect.innerHTML += `<option value="${p}">${p}</option>`;
                });

                typeSelect.value = typeValue;
                providerSelect.value = providerValue;
            },

            resetFilters() {
                document.getElementById('filterYear').value = '';
                document.getElementById('filterType').value = '';
                document.getElementById('filterProvider').value = '';
                this.updateDashboard();
            },

            renderCharts(filtered) {
                // CA par mois
                const monthlyData = {};
                filtered.forEach(d => {
                    const month = d.date.substring(0, 7);
                    const ca = d.services.reduce((sum, s) => sum + (s.quantity * s.price * 1.20), 0);
                    monthlyData[month] = (monthlyData[month] || 0) + ca;
                });

                const months = Object.keys(monthlyData).sort();
                const caValues = months.map(m => monthlyData[m]);

                this.createChart('chartCA', 'line', {
                    labels: months,
                    datasets: [{
                        label: 'CA (‚Ç¨)',
                        data: caValues,
                        borderColor: '#2180d1',
                        backgroundColor: 'rgba(33, 128, 209, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                });

                // Devis par type
                const typeData = {};
                filtered.forEach(d => {
                    d.services.forEach(s => {
                        typeData[s.type] = (typeData[s.type] || 0) + 1;
                    });
                });

                const typeLabels = Object.keys(typeData);
                const typeValues = Object.values(typeData);

                this.createChart('chartType', 'bar', {
                    labels: typeLabels,
                    datasets: [{
                        label: 'Nombre de devis',
                        data: typeValues,
                        backgroundColor: '#20a85d'
                    }]
                });

                // Top 5 clients
                const clientData = {};
                filtered.forEach(d => {
                    const ca = d.services.reduce((sum, s) => sum + (s.quantity * s.price * 1.20), 0);
                    clientData[d.client] = (clientData[d.client] || 0) + ca;
                });

                const sortedClients = Object.entries(clientData)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);

                this.createChart('chartClients', 'horizontalBar', {
                    labels: sortedClients.map(c => c[0]),
                    datasets: [{
                        label: 'CA (‚Ç¨)',
                        data: sortedClients.map(c => c[1]),
                        backgroundColor: '#ff7f00'
                    }]
                });

                // Statuts
                const statusData = {
                    'Accept√©s': filtered.filter(d => d.status === 'accepted').length,
                    'Refus√©s': filtered.filter(d => d.status === 'rejected').length,
                    'En cours': filtered.filter(d => d.status === 'pending').length
                };

                this.createChart('chartStatus', 'doughnut', {
                    labels: Object.keys(statusData),
                    datasets: [{
                        data: Object.values(statusData),
                        backgroundColor: ['#20a85d', '#d32f2f', '#ff7f00']
                    }]
                });
            },

            createChart(elementId, type, options) {
                const ctx = document.getElementById(elementId);
                if (!ctx) return;

                // D√©truire le graphique existant
                if (this.charts && this.charts[elementId]) {
                    this.charts[elementId].destroy();
                }
                if (!this.charts) this.charts = {};

                const chartType = type === 'horizontalBar' ? 'bar' : type;
                const chartOptions = {
                    type: chartType,
                    data: options,
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                display: type !== 'line' && type !== 'bar'
                            }
                        },
                        indexAxis: type === 'horizontalBar' ? 'y' : 'x',
                        scales: type === 'doughnut' ? {} : {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                };

                this.charts[elementId] = new Chart(ctx, chartOptions);
            }
        };

        // Initialisation
        app.init();
    </script>
</body>
</html>
